# Detailed Context

- `wgp.py` remains the central orchestrator; queue management and generation logic are still co-located there, but the queue renderer now emits text-only summaries suitable for CLI logging.
- `cli.queue_state.QueueStateTracker` is the canonical queue telemetry surface; the `core.queue_state` shim has been removed so downstream scripts must import from `cli.queue_state`.
- `cli.generate` traps `KeyboardInterrupt`, signalling the shared queue helpers (`QueueController.clear_queue` / `reset_generation_counters`) so headless runs exit cleanly without leaving background workers around.
- Abort/clear operations now route through `cli.queue_state` helpers (`request_abort`, `clear_pending_tasks`, `reset_generation_counters`) with `cli.queue_controller` exposing `request_abort()` / `clear_queue()` for headless callers; `wgp.clear_queue_action` is a thin shim for legacy compatibility.
- Legacy extras such as `one_more_sample` / `one_more_window` have been removed from `wgp.py`; headless runs now rely solely on the counters managed by `cli.queue_state` helpers.
- `cli.runner` now houses the log-only notifier and command dispatcher, mirroring `wgp` progress/state updates so the callback logic can migrate out of `wgp.py` without breaking CLI telemetry.
- CLI entrypoints (`cli.generate`, `cli.matanyone`) configure shared notifications with their loggers so headless workflows emit structured logs without invoking legacy sound hooks.
- `cli.queue_control_server.QueueControlServer` provides an opt-in TCP control channel (pause/resume/status) for long-running headless batches; `cli.queue_control` is the companion client that sends commands to the listener.
- The AsyncStream-backed `cli.queue_controller.QueueController` now drives the headless queue; the legacy `wgp.process_tasks` loop and `--legacy-queue` flag have been removed, leaving the CLI controller as the sole orchestration path.
- Shared queue helpers (`clear_queue_action`, `generate_queue_summary`, `update_queue_data`) now live in `cli.queue_utils`, so both the CLI controller and the legacy `wgp` shim share a single implementation while presenting the legacy return shape.
- Status/reset helpers (`clear_status`, `get_latest_status`, `update_status`) moved into `core.progress` alongside the refresh-id counter; `LegacyGenerationNotifier` and CLI callbacks now import them directly instead of reaching through `wgp`.
- `get_gen_info` is now sourced from `shared.utils.process_locks` everywhere (including `wgp`), so future refactors can treat queue/task helpers as pure functions without duplicating the state bootstrap.
- `preprocessing/matanyone/app.py` has been rewritten as a headless pipeline that requires on-disk template masks and GPU access; a dedicated CLI wrapper still needs to surface the new API.
- MatAnyOne CLI contract: accepts a video or still image, a grayscale mask aligned to the first processed frame, optional frame windowing, and produces foreground/alpha MP4 pairs (plus optional RGBA ZIP) under `mask_outputs/`, reattaching source audio when requested.
- Multiple model families (Wan, Flux, Qwen, Chatterbox, LTX) remain in-tree; CLI coverage is strongest for Wan, with other families pending validation.
- `cli/matanyone.py` now implements the MatAnyOne CLI wrapper, reusing `cli.telemetry.configure_logging`, validating media/mask paths, exposing frame range/dimension/mask-type/audio/codec flags (with dry-run support), and forwarding requests to `preprocessing.matanyone.app.generate_masks` using a fresh CLI GPU state plus log-backed notifier.
- Removed the legacy theme configuration surface in `wgp.py` (`--theme` flag plus `UI_theme`/`queue_color_scheme` defaults); confirmed no downstream callers rely on these settings and CLI logging remains unaffected.
- Headless flow now routes CLI → `core.production_manager.ProductionManager.run_generation()` → `wgp.generate_video()`; the manager is a temporary bridge while we peel helpers into `core/` ahead of deleting `wgp.py`. A detailed diagram plus follow-ups live in `docs/APPENDIX_HEADLESS.md`.
- Model footprint: keep `models/wan` (and associated defaults/presets/settings) plus shared utilities; treat `models/flux`, `models/qwen`, `models/chatterbox`, and `models/ltx_video` as optional until full CLI parity exists; retain only stateless preprocessing helpers under `preprocessing/`.
- CLI flag reference migrated to `docs/CLI.md`; new runtime toggles should be documented there instead of embedding matrices in this file.
- Documentation audit confirms GUI theme and queue color references have been removed from maintained guides; no textual cleanup pending for this surface.
- Queue summaries now annotate attached media (start/end/guide/mask cues) and preview refreshes emit debug logs, eliminating the need for legacy modal HTML helpers in `wgp.py`.
- Preview thumbnails are now assembled inside `cli.queue_utils` (`get_preview_images` / `update_task_thumbnails`), so both `wgp.py` and the CLI queue controller rely on the same headless helper while keeping notifier refreshes consistent.
- `cli.runner.CLIGenerationNotifier` now routes preview refresh events through `update_task_thumbnails`, ensuring queue entries stay aligned with refreshed assets during headless runs.
- Queue tracker migration Phase 3 complete: CLI modules and `ProductionManager` depend directly on `cli.queue_state`, and the `core.queue_state` module has been deleted; note the change in downstream docs/CHANGELOG so any external scripts update their imports.
- Retired the unused queue editing/modal/progress HTML functions (`handle_queue_action`, `refresh_preview`, `show_modal_image`, `create_html_progress_bar`, `update_generation_status`) and removed the `ui.html` shim; CLI telemetry already covers progress reporting.
- `wgp.initialize_runtime()` now builds a headless default namespace without touching `_parse_args()`, so importing the module no longer consumes CLI flags; callers can re-run the idempotent bootstrap via `ensure_runtime_initialized` while the CLI continues to rely on runtime overrides for per-run tweaks.
- Removed the orphaned Gradio scaffolding in `wgp.py` (`set_gallery_tab`, `generate_video_tab`, `get_js`, `create_ui`) along with the embedded JS payloads; no GUI-only helpers remain in the headless build.
- Remaining `ui.*` compatibility helpers (147x `ui.update`, 61x `ui.button`, etc.) are now confined to legacy preset/model management surfaces that the CLI never touches; they remain candidates for deletion or conversion to structured logging.
- Hoisted `DEFAULT_BOOTSTRAP_VALUES` into `shared/bootstrap_defaults.py`, dropped the defunct `betatest` / `multiple_images` flags, and now import the canonical defaults in `wgp`.
- Shared the bootstrap module with the CLI and extended `_load_server_config` to seed `check_loras`, `save_masks`, `save_quantized`, `save_speakers`, and `verbose_level` so persistent toggles no longer rely on the runtime namespace.
- Exposed the persisted runtime toggles (`save_masks`, `save_quantized`, `save_speakers`, `check_loras`) through headless CLI flags that keep `wgp.args` and `server_config` in sync during runs.
- Normalised the bootstrap defaults for `preload`, `profile`, and `verbose` to integers and hardened `_build_default_args` coercion so downstream code no longer relies on string shims.
- Queue editing stubs (`move_task`, `remove_task`, `finalize_generation_with_state`) have been removed; `update_queue_data` now returns a plain CLI summary dict so downstream code can introspect without UI components.
- Remaining `ui.*` usage now lives inside preset/model selection and legacy settings panes that are unreachable from the CLI; queue operations run entirely via CLI-native returns.
- Removed the prompt wizard/LoRA preset helpers from `wgp.py`, collapsing the compatibility shims and pointing operators to the existing CLI LoRA flags instead of macro-based prompts.
- Retired the queue load/save/autosave handlers plus their filesystem side effects; the CLI documentation now directs batching workflows toward explicit shell scripting rather than zipped queue archives.
- Removed the queue editing helpers (`silent_cancel_edit`, `cancel_edit`, `edit_task_in_queue`, `process_prompt_and_add_tasks`, `init_process_queue_if_any`) and deleted the pause-for-edit loop; the CLI queue no longer exposes edit state or `queue_paused_for_edit`.
- Documentation sweep (`README.md`, `docs/APPENDIX_HEADLESS.md`, `docs/*.md`) turned up no leftover references to queue archives or the prompt wizard; `docs/CLI.md` already notes both removals.
- Remaining UI-bound helpers fall into four dead zones: (1) generation button/preview gates (`abort_generation`, `prepare_generate_video`, the `ui.text` branch in `process_tasks`) that only impacted the dashboard; (2) LoRA preset editors (`validate_delete_lset`, `validate_save_lset`, `cancel_lset`, `save_lset`, `delete_lset`, `refresh_lora_list`) superseded by CLI flags; (3) media picker/post-processing hooks (`video_to_control_video`, `video_to_source_video`, `image_to_ref_image_*`, `audio_to_source_set`, `apply_post_processing`, `remux_audio`, `use_video_settings`) that correspond to removed upload widgets; and (4) model/preset switches (`record_image_mode_tab`, `load_settings_from_file`, `preload_model_when_switching`, the refresh_* helpers, `detect_auto_save_form`, `generate_dropdown_model_list` + `change_model_*`) which orchestrated UI dropdowns. None have CLI call sites today.
- Excised `abort_generation`, `prepare_generate_video`, the LoRA preset editors, and the media picker/post-processing helpers; queue state transitions now rely purely on logging and dict returns instead of `ui.*`.
- Updated `process_tasks` to emit timestamp tuples for preview refreshes so the generator is fully headless while retaining cached previews for debugging.
- Implemented a CLI `--settings-file` flag that now delegates to `core.task_inputs.TaskInputManager.load_settings_from_file` (resolved through `ProductionManager.task_inputs()`) to load JSON or embedded media metadata, merge defaults ahead of CLI overrides, and abort when the file targets a different model type.
- Removed the legacy model/preset switching helpers (`record_image_mode_tab`, `switch_image_mode`, `change_model*`, `generate_dropdown_model_list`, `create_models_hierarchy`, etc.); `wgp.py` no longer imports `defaultdict` or returns `ui.dropdown` instances, and `python -m compileall wgp.py` still passes.
- Prompt enhancement now runs exclusively through `process_prompt_enhancer` inside `generate_video`; the manual `enhance_prompt` trigger along with the prompt-type, resolution/group, auto-save, and LoRA download UI wrappers have been deleted, so CLI configs (or future flags) are the sole control surface for that feature set.
- Proposed a CLI-facing control surface for the enhancer: add a `--prompt-enhancer` flag mapping to the legacy `"", "T", "I", "TI"` modes (off / text / image / text+image) and introduce a provider selector so the Florence2+LLaMA stack and future cloud LLMs can share the same entry point.
- Confirmed there are no remaining `ui.update` call sites; `shared.ui_compat` is now effectively idle and can be removed once the last compatibility hooks are collapsed.
- Audited CLI overrides: prompt enhancer/provider, `--output-dir`, and `--profile` mutate in-memory runtime state only; documented the per-run behaviour in CLI help/docs so operators know to edit `wgp_config.json` when they want new defaults.
- Converted `core/io` into a package so `core.io.media` can live alongside the filename allocator; `core.io.__init__` now re-exports `get_available_filename` plus the media helpers to keep import surfaces stable.
- IO helper call sites (2025-02-24):
  - `wgp.generate_video` still uses `shared.utils.audio_video.save_video` for primary renders and debug dumps plus `save_image` for previews, but metadata now flows through `core.io.write_metadata_bundle` with per-type configs.
  - `preprocessing.matanyone.app._save_outputs` persists foreground/alpha MP4s via `save_video` and embeds run metadata for each artifact through `write_metadata_bundle`.
  - No other modules currently invoke the metadata bundler; the legacy `save_*_metadata` wrappers remain as temporary shims until we delete them.
- Save helper dependency map:
  - `core.io.media.write_video` accepts torch tensors or numpy frames, performs the legacy normalization/grid logic, merges codec parameters, and logs retry failures through the injected logger.
  - `core.io.media.write_image` preserves the PNG/WebP/JPEG handling (including RGBA promotion to PNG) and surfaces retry exhaustion through the logger while still returning the resolved path for compatibility.
- Metadata bundler `write_metadata_bundle` infers the artifact type from the path/format hint, dispatches to the existing `save_*_metadata` helpers, and emits logger-aware diagnostics when persistence fails.
- `ProductionManager` now supplies `metadata_choice` plus cloned `MetadataSaveConfig` defaults ahead of each run so `wgp.generate_video` and post-processing flows embed metadata (or emit JSON sidecars) without consulting CLI state directly.
  - The MatAnyOne CLI forwards `request.codec` directly to `save_video`, so the new abstraction must preserve per-request codec overrides while still supporting `server_config` defaults used by `wgp`.
  - ProductionManager can now rely on the notifications logger default, but future metadata work still needs injectable logger hooks to replace the remaining `print` usage.
  - Generation CLI exposes `--metadata-mode` for per-run selection, persists the override on queued tasks so resumed work honours it, and MatAnyOne now pulls metadata configs from the shared factory instead of instantiating templates manually.
  - Metadata state migration plan:
    - Add a lightweight `MetadataState` dataclass to `ProductionManager` that snapshots `metadata_choice` and cloned config templates; expose a getter so non-`wgp` pipelines can request the state without touching globals.
    - Update `GenerationRuntime` and `wgp.generate_video` to accept an explicit metadata payload (choice + configs) so the runtime bridge assigns state through parameters instead of mutating module-level globals.
    - After call sites adopt the explicit parameters, delete `wgp.metadata_choice`/`metadata_configs`, collapse `_resolve_metadata_config` to consume the injected state, and document the new API contract in `docs/CLI.md`.
- MatAnyOne’s CLI now forwards a per-run `metadata_mode` selection to `_save_outputs`, embedding metadata by default or emitting JSON sidecars when requested. The request object validates the flag so downstream pipelines can reuse the same semantics.
- `_resolve_metadata_config` defers to `core.io.media.build_metadata_config`, keeping the embedded source-image wiring but dropping the bespoke clone logic, and `ProductionManager.metadata_config_templates()` exposes cloned templates for other pipelines that need consistent handler overrides.
- `core/io/media` now implements `write_video` and `write_image` with the legacy preprocessing/retry behaviour plus logger hooks; `shared.utils.audio_video` is a thin adapter that builds the configs and defaults to the notifications logger. `wgp` wraps the helpers to inject the logger for every call, and MatAnyOne forwards the CLI logger so persistence errors surface through structured logs.
- Detailed migration notes live in `docs/IO_MEDIA_MIGRATION.md`; update that plan as helpers move.
- `generate_video` dependency inventory captured for the upcoming `cli.runner`: global state (`wan_model`, `offloadobj`, `server_config`, `save_path`/`image_save_path`, `processing_device`, `default_profile`, `verbose_level`, `prompt_enhancer_*` models), in-module helpers (`get_gen_info`, `prepare_inputs_dict`, `process_prompt_enhancer`, `load_models`, `update_task_thumbnails`, `clear_status`, `release_model`), filesystem/metadata utilities (`get_available_filename`, `save_video`, `save_image`, `save_*_metadata`, `truncate_for_filesystem`), and notifier/hooks (legacy `notification_sound`, CLI-provided progress callbacks via `cli.runner`). These will need explicit parameters or adapters when extracting the runner.
- `core.production_manager.ProductionManager` now exposes the headless orchestration surface; it still delegates to `wgp.generate_video`, but the long-term plan is to delete `wgp.py` once all helpers migrate. The relocated `GenerationRuntime` context manager lives alongside the manager so callers outside the CLI can reuse the override plumbing without importing CLI modules.
- Production Manager now requires caller-supplied notifiers, primes the `state["gen"]` dictionary, wraps each run with progress resets, and handles model reload checks before delegating to `wgp.generate_video`, trimming the legacy dependency surface further.
- Preview updates now flow through `core.preview.prepare_preview_inputs`, which replaces the older `locals()` snapshot in `wgp.generate_video` so notifier hooks receive only the curated asset payload they require.
- `cli/runner.py` continues to provide the CLI notifier, progress callback builder, and `send_cmd` helper, now wiring them through `ProductionManager` so CLI entrypoints stop instantiating `GenerationRuntime` directly.
- Outlined the runner extraction path: introduce a `cli.runner` module that accepts sanitized params plus an event sink, inventory the `wgp` globals it consumes (model registry, notifier hooks, save-path helpers), and stage follow-ups to peel those dependencies off before swapping callers.
- Proposed queue controller design: create a dedicated `cli.queue_controller` module that owns the `gen_lock` negotiation loop, uses `AsyncStream` to spawn worker threads per task, forwards notifier/preview events via `send_cmd`, and exposes async-friendly hooks for future multi-worker scheduling. Dependencies to inject: `ProductionManager` for execution, notifier factory, a shared `cli.queue_state.QueueStateTracker`, and structured logging.
- Added `shared.notifications.GenerationNotifier` with a legacy shim that proxies `clear_status`, `update_task_thumbnails`, and `notification_sound` so CLI callers can inject log-only behaviour without touching `wgp.generate_video`.
- `core.task_inputs.TaskInputManager` now owns `prepare_inputs_dict`, `get_file_list`, `set_file_choice`, and `save_inputs`, accepting explicit dependency injections (model metadata readers, server config, locks) and exposing a `SaveInputsPayload` dataclass instead of the old `locals()` scrape; `wgp` wraps the manager via `_get_task_inputs_manager()`, while `ProductionManager`/`QueueController` surface `task_inputs()` so CLI flows can share the same serializer.
- Queue controller enqueue now calls `TaskInputManager.prepare_inputs_dict("metadata", ...)`, refreshing the LoRA URL cache, normalising activation lists, and storing queue metadata/attachment labels directly in CLI space so `wgp.update_loras_url_cache` could be removed.
- Runner migration outline (2025-02-17):
  1. Detach queue state mutation helpers (`get_gen_info`, notifier wiring, CLI progress callbacks) into `cli.runner` so the module drives progress events without relying on `wgp` globals. (`build_callback` has been replaced with `cli.runner.build_progress_callback`.)
  2. Extract file system helpers (`get_available_filename`, `save_video`/`save_image`, metadata writers) into a dedicated `core/io.py` namespace and inject them via the runner to shrink `wgp` dependencies.
  3. Hoist prompt enhancer and LoRA preparation into pre-run adapters that yield a serialisable config blob, allowing the runner to operate on explicit inputs rather than mutating `state`.
  4. Introduce smoke validations: `python -m cli.generate --prompt "smoke test" --dry-run --log-level INFO` for argument parsing, a low-resolution generation run to confirm media outputs, and a MatAnyOne pass to ensure shared notifier wiring remains consistent across pipelines.

## Queue Controller Draft

- Controller entrypoint will accept a `ProductionManager`, a notifier factory, and a shared `cli.queue_state.QueueStateTracker` so the loop operates without reading module globals directly.
- The main loop already mirrors the retired `wgp.process_tasks` flow: it waits on `gen_lock` for `"process:main"`, drains queued tasks, and launches worker coroutines via `AsyncStream`/`async_run` while routing events back through `send_cmd`.
- Preview/progress events continue flowing through the CLI `send_cmd` helper; the controller will attach the CLI callback builder before dispatch so pause/resume semantics stay consistent.
- Abort handling resets `gen["abort"]`, clears the queue entry, and emits final status updates through the notifier; controller consumers can hook structured logging without reaching into `wgp`.
- Error paths will translate exceptions into `GenerationError`, flush the queue, and surface user-facing messages via notifier/logs while leaving GPU cleanup to the manager-provided callbacks.
- `cli.queue_controller.QueueController` mirrors the event pump through `AsyncStream`, now drives the default CLI queue while updating the shared tracker, serialises queue entries (prompt/repeat/media flags) via the shared TaskInputManager, and will be extended for multi-task scheduling before the legacy loop is deleted. The optional TCP control server wraps these methods so operators can manage long-running batches without a GUI.

- ProductionManager dependency inventory (2025-02-18): runtime reload paths still touch `wan_model`, `transformer_type`, `reload_needed`, and `load_models`; task input wiring depends on `wgp` for model discovery, compatibility tests, settings writers, notifications, and the shared `lock`; output persistence flows rely on `get_available_filename` plus the inline save/metadata helpers; prompt/LoRA prep (`setup_loras`, `extract_preset`, `process_prompt_enhancer`, enhancer bootstraps) remain in `wgp`; queue progress defaults fall back to `create_legacy_notifier`/`update_task_thumbnails`. Next refactor should hoist `get_available_filename` into `core/io.py` so `ProductionManager` can drop its last direct file-path dependency on `wgp` before relocating the remaining save/metadata utilities.
