# Work History

- Extracted `get_available_filename` into `core/io.py`, updated `wgp.py` to consume the shared helper, documented the relocation plus `save_*` call-site inventory, and validated with `python -m compileall core/io.py wgp.py`.
- Created `docs/IO_MEDIA_MIGRATION.md` capturing the `save_video`/`save_image`/metadata extraction strategy, expanded `docs/CONTEXT.md` with dependency notes (codec handling, logger requirements, MatAnyOne overrides), and refreshed `PROJECT_PLAN_LIVE.md` `## Immediate Next Actions` for the next migration step; documentation-only update, no validation needed.
- Catalogued the remaining `ProductionManager` touchpoints inside `wgp.py` (runtime reload hooks, TaskInputManager dependencies, output persistence helpers, prompt/LoRA prep, queue notifier fallbacks) and updated `PROJECT_PLAN_LIVE.md` / `docs/CONTEXT.md` to stage the `core/io.get_available_filename` extraction; planning-only changes, so no runtime validation executed.
- Removed the `core.queue_state` shim (all callers now import `cli.queue_state`), deleted the legacy module, refreshed docs/CONTEXT.md and `PROJECT_PLAN_LIVE.md`, and validated with `python -m cli.generate --prompt "smoke test prompt" --dry-run --log-level INFO`.
- Removed the `--legacy-queue` flag and deleted `wgp.process_tasks`, making the CLI queue controller the sole orchestration path and updating docs/CLI+Appendix accordingly; validated with `python -m cli.generate --prompt "smoke test prompt" --dry-run --log-level INFO`.
- Wired `cli.runner.CLIGenerationNotifier` through `cli.queue_utils.update_task_thumbnails`, ensuring queue entries refresh their preview attachments during headless runs, updated the CLI instantiation to pass the shared state dict, and validated with `python -m cli.generate --prompt "smoke test prompt" --dry-run --log-level INFO`.
- Completed queue tracker migration Phase 2 by pointing CLI modules and `core.production_manager.ProductionManager` at `cli.queue_state`, injecting the tracker/update helpers via the manager constructor, and revalidating with `python -m cli.generate --prompt "smoke test prompt" --dry-run --log-level INFO`.
- Audited the codebase for `core.queue_state` usage (docs-only), captured the shim removal checklist in `docs/CONTEXT.md`, and updated `PROJECT_PLAN_LIVE.md` to focus next on retiring the legacy `wgp.process_tasks` loop.
- Confirmed `wgp.process_tasks` has no in-repo callers (only documentation references via `--legacy-queue`), noted the removal steps (drop flag/docs, delete loop, trim thread_utils dependency) in `docs/CONTEXT.md`, and refreshed `PROJECT_PLAN_LIVE.md` to stage that cleanup.
- Landed queue tracker migration Phase 1: added `cli/queue_state.py`, converted `core/queue_state.py` into a compatibility re-export over the CLI helpers, and re-ran `python -m cli.generate --prompt "smoke test prompt" --dry-run --log-level INFO` to confirm the shim holds.
- Outlined the queue tracker migration strategy (Phase 1: add `cli.queue_state` with a compatibility shim; Phase 2: reroute CLI callers and `ProductionManager` via dependency injection; Phase 3: remove the shim alongside the legacy queue loop) and updated `PROJECT_PLAN_LIVE.md` / `docs/CONTEXT.md` accordingly.
- Retired the InsightFace-based `preprocessing/face_preprocessor.py`; Lynx and Stand-in code paths now halt with clear messages until the replacement cropper exists.
- Moved queue preview thumbnail helpers into `cli.queue_utils`, introduced `shared/utils/image.pil_to_base64_uri`, updated `wgp.py` and the CLI queue controller to consume the shared helper, and validated with `python -m compileall wgp.py cli/queue_utils.py cli/queue_controller.py shared/utils/image.py` plus `python -m cli.generate --prompt "smoke test prompt" --dry-run --log-level INFO`.
- Deleted the HyVideo/Hunyuan stack (code, defaults, lora scaffolding); removed all documentation and runtime references so the CLI focuses on Wan/Flux/LTX/Qwen/Chatterbox families.
- Created `cli/generate.py` to invoke `generate_video()` headlessly with CLI-friendly logging and a dry-run configuration test to confirm argument parsing.
- Drafted a CLI-oriented architecture map detailing the flow from argument parsing through model execution to output emission.
- Unified CLI and legacy code paths by introducing `assemble_generation_params()` with shared fallback defaults.
- Captured the proposed CLI argument surface and enumerated required file-based inputs for non-interactive workflows.
- Introduced `cli/arguments.py` to centralize the CLI flag surface, expanded `cli/generate.py` to forward path-based inputs, and updated `wgp._parse_args` to tolerate unknown flags; validated with `python -m cli.generate --prompt "test prompt" --dry-run`.
- Added CLI-side file path validation across all media inputs, exiting early with actionable errors; exercised via `python -m cli.generate --prompt "test" --dry-run --image-start missing.png`.
- Replaced ad-hoc `print` statements with structured CLI logging backed by a configurable `--log-level`; built send_cmd telemetry hooks and validated with `python -m cli.generate --prompt "test prompt" --dry-run --log-level DEBUG`.
- Audited `GENERATION_FALLBACKS` against per-model defaults; added `tea_cache_setting` and `tea_cache_start_step_perc` fallbacks to preserve parity for TEA cache workflows.
- Cataloged all remaining Gradio-dependent modules (core UI bootstrap, shared/gradio widgets, plugin system, stats panel, process locks, and Wan/Qwen/Chatterbox handlers) and tagged each for removal or CLI refactor follow-ups.
- Removed direct Gradio usage from Wan/Qwen/Chatterbox model handlers by wiring a shared CLI notifier to the generation logger; confirmed CLI dry-run still passes.
- Replaced the GPU lock wait notification with a logger/callable hook (`shared/utils/process_locks.py`), updated MatAnyOne to pass a Gradio callback locally, and removed the Gradio-only stats streamer (`shared/utils/stats.py` + related `wgp.py` wiring); validated with `python -m cli.generate --prompt "test" --dry-run`.
- Routed remaining notification paths in `wgp.py` through `shared.utils.notifications` by swapping `gr.Info`/`gr.Warning`/`gr.Error` for logger-backed helpers and a new `GenerationError`, preserving CLI error reporting; confirmed via `python -m cli.generate --prompt "test prompt" --dry-run`.
- Removed the dormant `wgp.py` UI hooks (`enhance_prompt`, `refresh_*prompt_type*`, resolution/guidance/auto-save toggles, and `download_lora`), keeping the generation-time `process_prompt_enhancer` flow intact; no runtime validation required for these deletions.
- Documented the upcoming CLI prompt-enhancer flags/provider abstraction and confirmed `ui.update` no longer appears anywhere, setting the stage to delete `shared/ui_compat.py` once remaining helpers are inlined.
- Added `shared/ui_compat.py` to encode legacy UI responses as dataclasses, replaced `gr.*` return values across the queue helpers in `wgp.py` with the new compatibility layer, and verified CLI dry-run `python -m cli.generate --prompt "test prompt" --dry-run`.
- Removed the plugin manager infrastructure (deleted `shared/utils/plugins.py`, `plugins/`, and `plugins.json`; stripped plugin imports/hooks from `wgp.py`); CLI dry-run `python -m cli.generate --prompt "test" --dry-run` still passes.
- Removed `shared/gradio/*` and replaced `AudioGallery` / `AdvancedMediaGallery` with inline minimal stubs inside `wgp.py`; CLI dry-run `python -m cli.generate --prompt "test" --dry-run` still passes.
- Eliminated the remaining gallery/playback code paths in `wgp.py`, replacing them with hard errors to enforce the headless-only policy; `python -m cli.generate --prompt "test" --dry-run` still passes.
- Replaced GUI-era documentation with CLI-first guidance: deleted `docs/PLUGINS.md`, rewrote `README.md`, refreshed `docs/CLI.md`, and condensed `docs/CHANGELOG.md` around the headless workflow; no runtime validation was required.
- Completed the documentation sweep for the remaining guides (`docs/INSTALLATION.md`, `docs/AMD-INSTALLATION.md`, `docs/GETTING_STARTED.md`, `docs/TROUBLESHOOTING.md`, `docs/FINETUNES.md`, `docs/LORAS.md`, `docs/MODELS.md`, `docs/VACE.md`), replacing Gradio/Docker instructions with CLI scenarios and noting current gaps (e.g. lora activation still configured via presets); focused on content updates, no code changes to validate.
- Implemented the CLI LoRA discovery and selection flow (`--list-loras`, `--list-lora-presets`, `--loras`, `--lora-preset`, `--lora-multipliers`) with preset parsing and logging hooks; exercised via `python -m cli.generate --prompt "test" --dry-run`, `--list-loras`, `--list-lora-presets`, and expected error paths for missing LoRA weights/presets.
- Exposed headless runtime controls by extending `cli/arguments.py`/`cli.generate.py` with attention, compile, profile/preload, dtype/quant, and TeaCache flags; injected per-run overrides into `wgp` state, refreshed dry-run reporting/logging, and documented the new surface in `docs/CLI.md`. Validated with `python -m cli.generate --prompt "test prompt" --dry-run --attention sdpa --compile --profile 3 --preload 512 --tea-cache-level 1.75 --tea-cache-start-perc 25 --transformer-quantization none --text-encoder-quantization fp8 --fp16`.
- Swapped the queue renderer in `wgp.py` for a text-only summary, deleted the `icons/` directory and `favicon.png`, removed `gradio`-specific types in favour of `ui.UIEvent`, and rebuilt `preprocessing/matanyone/app.py` as a headless mask-propagation pipeline with explicit request/result dataclasses; sanity-checked with `python -m compileall wgp.py` and `python -m compileall preprocessing/matanyone/app.py`.
- Added `cli/matanyone.py` to expose MatAnyOne mask propagation as a CLI command with logging, path validation, frame/mask/audio controls, and dry-run support; documented the workflow in `docs/CLI.md` and verified the parser with `python -m cli.matanyone --help`.
- Reorganized `PROJECT_PLAN_LIVE.md` to keep context/responsive sections concise, moved the architecture diagram and follow-ups into `docs/APPENDIX_HEADLESS.md`, and pointed readers to `docs/CLI.md` for the canonical flag surface.
- Removed the obsolete CLI theme surface (`--theme`, `UI_theme`, `queue_color_scheme`) from `wgp.py`; confirmed the parser via `python -m cli.generate --prompt "smoke test prompt" --dry-run --log-level INFO`.
- Audited documentation and tracked assets for GUI theme or queue color mentions; none remain, so no textual updates were required this session.
- Inspected `wgp.py` and `shared/ui_compat.py` for legacy HTML/theme hooks, catalogued the unused preview-modal/progress helpers, and staged follow-up tasks to replace them with CLI logging.
- Confirmed via `rg` that the preview/modal/progress helpers have no runtime callers, drafted the CLI logging replacement strategy, and updated the roadmap plus next steps accordingly.
- Updated queue summaries to flag attached media, log thumbnail refreshes at debug level, removed dormant modal/progress helpers (`handle_queue_action`, `refresh_preview`, `show_modal_image`, `create_html_progress_bar`, `update_generation_status`), and dropped `ui.html`; validated with `python -m compileall wgp.py shared/ui_compat.py`.
- Tallied remaining `ui.*` compatibility usage (e.g., 147 `ui.update`, 61 `ui.button`) within queue editing, wizard, and preset routines, and committed to removing those chains or providing explicit CLI error paths.
- Excised unused queue editing helpers (`move_task`, `remove_task`, `finalize_generation_with_state`) and converted `update_queue_data` to return a CLI-friendly summary dict rather than `ui.text`.
- Audited the surviving `ui.*` call sites (prompt wizard, LoRA presets, queue import/autosave) and confirmed they are unreachable via CLI execution; leaning toward removal instead of building equivalent CLI surfaces unless new requirements emerge.
- Drafted removal proposals covering the prompt wizard/LoRA preset helpers and the queue import/autosave routines so the next iteration can either land CLI replacements or delete the dead UI scaffolding.
- Removed the prompt wizard/LoRA preset helpers plus queue load/save/autosave handlers from `wgp.py`, pruned the associated constants/imports, refreshed `docs/CLI.md` with LoRA guidance and queue automation notes, and validated the module with `python -m compileall wgp.py`.
- Audited documentation for lingering queue archive or prompt wizard references; confirmed the updates are confined to `docs/CLI.md` and no additional cleanup is required.
- Excised the remaining queue editing helpers (`silent_cancel_edit`, `cancel_edit`, `edit_task_in_queue`, `process_prompt_and_add_tasks`, `init_process_queue_if_any`), removed the `queue_paused_for_edit` loop, dropped the now-unused `clean_image_list`, and recompiled `wgp.py` via `python -m compileall wgp.py` to confirm a clean headless build.
- Removed the lingering dashboard helpers (`abort_generation`, `prepare_generate_video`), LoRA preset editors, media picker/post-processing hooks, and `load_settings_from_file`; rewired `process_tasks` preview yields to timestamp tuples and verified `python -m compileall wgp.py`.
- Restored the `video_guide_processes` constant in `wgp.py` to resolve the undefined reference surfaced by Pylance after the UI compatibility layer removal; validated with `python -m compileall wgp.py`.
- Landed CLI prompt enhancer controls by adding `--prompt-enhancer`/`--prompt-enhancer-provider`, wired the selections into `cli.generate.apply_runtime_overrides` and `build_params`, refreshed dry-run reporting, and documented the new surface in `docs/CLI.md`; validated with `python -m compileall cli/generate.py`.
- Deleted `shared/ui_compat.py`, removed its `wgp.py` import, and confirmed the headless runtime compiles cleanly with `python -m compileall wgp.py`.
- Introduced `core/production_manager.py` with a transitional `ProductionManager` class plus the relocated `GenerationRuntime`, ensuring per-run overrides and notifier plumbing live outside the CLI package; refactored `cli.generate` to instantiate the manager and route generations through it while `cli.runner` now focuses on notifier/progress helpers.
- Updated `docs/CONTEXT.md`/`PROJECT_PLAN_LIVE.md` to note the new manager as the eventual `wgp.py` replacement and outlined the upcoming `cli.queue_controller` design (lock negotiation, `AsyncStream` handling, notifier/log hooks) ahead of migrating the queue loop.
- Validation: `python -m cli.generate --prompt "smoke test prompt" --dry-run --log-level INFO`.
- Added a `--settings-file` CLI flag that merges saved defaults ahead of explicit overrides, updated `docs/CLI.md`, validated parsing with `python -m compileall cli/generate.py`, and exercised the dry-run path via `python -m cli.generate --prompt "test" --dry-run`.
- Deleted the model/preset switching shims (`record_image_mode_tab`, `switch_image_mode`, `change_model*`, `generate_dropdown_model_list`, `create_models_hierarchy`) and orphaned imports, then recorded the outstanding `ui.update` hotspots (prompt enhancer + prompt-type toggles, resolution/guidance controls, auto-save/video-length hooks) for follow-up; re-ran `python -m compileall wgp.py`.
- Removed the dormant prompt enhancer UI helpers from `wgp.py`, documented the change in the roadmap (shared prompt enhancer + future cloud providers), and deferred runtime validation because no executable paths were touched.
- CLI prompt enhancer controls now ship as `--prompt-enhancer` (text/image/combined) with an optional `--prompt-enhancer-provider` flag that maps to `server_config["enhancer_enabled"]` (0=off, 1=Florence2+Llama3.2, 2=Florence2+JoyCaption) while preserving the disabled default when both flags are omitted.
- Deleted `shared/ui_compat.py`; the headless runtime no longer imports the compatibility layer and `wgp.py` operates purely with CLI returns.
- Reviewed `wgp.py` for lingering UI scaffolding, documented the `_parse_args` bootstrap side effects and orphaned JS helpers, and refreshed `## Immediate Next Actions` to prioritize splitting the runner from the legacy UI hooks.
- Replaced the import-time `_parse_args()` side-effects with `_build_default_args()` and `initialize_runtime()`, added `ensure_runtime_initialized()` for idempotent bootstrapping, updated the CLI wrapper to call it, and deleted the final Gradio helpers (`set_gallery_tab`, `generate_video_tab`, `get_js`, `create_ui`); validated via `python -m compileall wgp.py` and `python -m compileall cli/generate.py`.
- Centralised the bootstrap defaults around `DEFAULT_BOOTSTRAP_VALUES`, added `_load_server_config()` to hydrate config before runtime overrides, updated `cli.generate` to call `ensure_runtime_initialized()`, and refreshed `docs/CLI.md` plus `docs/APPENDIX_HEADLESS.md` with the runtime bootstrap guidance; revalidated via `python -m compileall wgp.py` and `python -m compileall cli/generate.py`.
- Relocated the bootstrap constants to `shared/bootstrap_defaults.py`, purged the unused `betatest`/`multiple_images` flags, extended `wgp.py` to read persistent toggles from `server_config`, wired `cli/arguments.py` to the shared defaults for help text, and recorded the changes in this plan; validated with `python -m compileall wgp.py cli/arguments.py cli/generate.py shared/bootstrap_defaults.py`.
- Surface the persisted runtime toggles in `cli.generate` (`--save-masks`, `--save-quantized`, `--save-speakers`, `--check-loras`), normalised `preload`/`profile`/`verbose` bootstrap values to integers, updated docs with the new flags, and verified the modules with `python -m compileall cli/generate.py cli/arguments.py shared/bootstrap_defaults.py wgp.py`.
- Ensured the CLI toggle overrides remain per-run by keeping them out of `server_config`, refreshed `docs/CLI.md` with the ephemeral contract, and confirmed dry-run/log visibility via `python -m cli.generate --prompt "test" --dry-run --save-masks --no-check-loras`.
- Audited CLI override persistence for prompt enhancer/provider, `--output-dir`, and VRAM profile flags; confirmed they stay per-run with no `wgp_config.json` writeback, captured the findings in context, and drafted the CLI runner extraction plan for follow-up work.
- Codified the per-run contract for prompt enhancer/provider, `--output-dir`, and VRAM profile overrides by updating CLI flag help and `docs/CLI.md`; persistent defaults still come from `wgp_config.json`.
- Catalogued the `wgp.generate_video` dependency surface (global runtime state, helper calls, filesystem/metadata utilities, notifier hooks) to guide the upcoming `cli.runner` extraction and noted which components need injection points.
- Added `cli/runner.py` with a `GenerationRuntime` wrapper plus `run_generation` helper, and updated `cli.generate` to call it so the runner logic is centralised ahead of deeper extraction work.
- Extended `GenerationRuntime` with context-managed overrides for `save_path`, `image_save_path`, and matching `server_config` entries, ensuring CLI output-directory changes stay per-run without permanently mutating legacy globals.
- Introduced `shared/notifications.py` with a `GenerationNotifier` interface and legacy shim that wraps `clear_status`, `update_task_thumbnails`, and `notification_sound`, updated `wgp.generate_video` to accept the notifier and removed direct calls to those helpers, refreshed `PROJECT_PLAN_LIVE.md` (`Context Highlights`, `Immediate Next Actions`, `Previous Work Highlights`) plus `docs/CONTEXT.md` with the runner migration outline; no runtime validation run because the changes only touch orchestration hooks.
- Introduced `cli.runner.CLIGenerationNotifier` and migrated the CLI `send_cmd` helper into the runner so progress/status updates mutate `state['gen']` in lockstep with `wgp`, passed the notifier through `GenerationRuntime`, and validated with `python -m cli.generate --prompt "test prompt" --dry-run --log-level INFO`.
- Hoisted progress formatting helpers into `core/progress.py`, refactored `wgp`/`cli.runner` to consume the shared utilities, mapped the queue/progress touchpoints in `wgp.process_tasks`, and revalidated with `python -m cli.generate --prompt "test prompt" --dry-run --log-level INFO`.
- Replaced `wgp.build_callback` with a CLI-supplied progress builder (`cli.runner.build_progress_callback`), injected it via `GenerationRuntime`, guarded the fallback path inside `wgp.generate_video`, wired MatAnyOne to the shared notification logger, and revalidated with `python -m cli.generate --prompt "test prompt" --dry-run --log-level INFO` plus `python -m cli.matanyone --help`.
- Production Manager now resolves default notifier/callback builders, wraps each run with progress resets, and preflights model reloads via a new `_ensure_model_ready` helper before calling `wgp.generate_video`, reducing legacy coupling while keeping override plumbing intact.
- Added `cli/queue_controller.QueueController` as the initial AsyncStream-driven queue pump, wired behind an opt-in `--experimental-queue-controller` flag in `cli.generate`, and ensured queue state cleanup plus process-status resets after each run.
- Updated `PROJECT_PLAN_LIVE.md` and `docs/CONTEXT.md` with the orchestration shift, queued follow-ups, and CLI flag status; validation: `python -m compileall core/production_manager.py cli/queue_controller.py cli/generate.py`.
- Hardened `ProductionManager` orchestration by requiring caller-supplied notifiers, priming `state["gen"]` before dispatch, replacing the legacy preview `locals()` snapshot with `core.preview.prepare_preview_inputs`, and keeping the preflight model load; extended `cli.queue_controller.QueueController` to drain sequential queues (with abort cleanup and global queue updates) behind `--experimental-queue-controller`, and refreshed docs/plan to capture the new default expectations; validation: `python -m compileall core/production_manager.py cli/queue_controller.py cli/generate.py`.
- Introduced `core/queue_state.QueueStateTracker` to centralize queue snapshots and summaries, wired `core.production_manager` plus `cli.queue_controller` to update it, and removed the `wgp` queue globals/aliases in favour of the shared tracker; validation: `python -m compileall core/queue_state.py core/production_manager.py cli/queue_controller.py wgp.py`.
- Extended `core.queue_state` with abort/clear/counter helpers, taught `cli.queue_controller.QueueController` to expose `request_abort()` / `clear_queue()` plus end-of-run counter resets, and slimmed `wgp.clear_queue_action` into a wrapper over the shared utilities; validation: `python -m compileall core/queue_state.py cli/queue_controller.py wgp.py`.
- Wired `cli.generate` to handle `KeyboardInterrupt` by invoking the shared queue helpers (clearing controller queues or toggling the legacy abort flag), logging structured summaries, and returning exit code 130; documented the change and noted remaining `wgp` queue extras. Validation: `python -m compileall cli/generate.py cli/queue_controller.py core/queue_state.py wgp.py`.
- Removed the dormant queue extras (`wgp.one_more_sample` / `one_more_window`) in favour of `core.queue_state` counter resets, added pause/resume APIs to `cli.queue_controller.QueueController`, made the controller the default CLI path with a `--legacy-queue` fallback, and introduced `cli.queue_controller_smoke` for pause-handshake validation; refreshed PROJECT_PLAN_LIVE.md, docs/CONTEXT.md, and docs/CLI.md to capture the new defaults and queue cleanup. Validation: `python -m compileall wgp.py cli/queue_controller.py cli/generate.py cli/arguments.py cli/queue_controller_smoke.py`; `python -m cli.queue_controller_smoke`; `python -m cli.generate --prompt "smoke test prompt" --dry-run --log-level INFO`; `python -m cli.generate --prompt "legacy queue test" --dry-run --legacy-queue`.
- Added an optional TCP control channel for the headless queue controller: `cli.generate` now accepts `--control-port/--control-host`, spins up `QueueControlServer`, and the new `cli.queue_control` helper issues pause/resume/status/abort commands; documented the workflow in PROJECT_PLAN_LIVE.md, docs/CLI.md, and docs/CONTEXT.md, and sketched the queue-loop removal sequence. Validation: `python -m compileall wgp.py cli/queue_controller.py cli/generate.py cli/arguments.py cli/queue_control_server.py cli/queue_control.py`; `python -m cli.generate --prompt "control test" --dry-run --control-port 9100`; `python -m cli.queue_controller_smoke`; ad-hoc socket test exercising pause/resume/status/abort commands against the control server.
- Updated PROJECT_PLAN_LIVE.md/docs.CONTEXT.md to capture the directive that queue helpers must migrate out of `core/`, refreshed docs.APPENDIX_HEADLESS.md with TCP control safeguards, converted `cli.queue_control.send_command` for line-buffered responses, added the TCP-backed pause/resume/status assertions to `cli.queue_controller_smoke`, flushed the server handler writes, and validated with `python -m cli.queue_controller_smoke` plus an interactive socket check.
- Compressed `PROJECT_PLAN_LIVE.md`’s `## Previous Work Highlights` into a short operator-facing summary per the handoff protocol while keeping the newest queue-control validation note surfaced.
- Trimmed `PROJECT_PLAN_LIVE.md`’s `## Context Highlights` to ~250 tokens focusing on runtime bootstrap, queue migration, production manager scope, and TCP control coverage so the summary stays scan-friendly and aligned with the headless vision.
- Added a first-read reminder atop the handoff protocol directing operators to `docs/CONTEXT.md` and `docs/WORK_HISTORY.md` so those references persist without bloating the highlight summaries.
- Audited documentation for lingering legacy queue loop references, updating `docs/CONTEXT.md` and `docs/APPENDIX_HEADLESS.md` to frame the CLI queue controller as the default with `--legacy-queue` as a compatibility shim; captured the next `wgp.py` decomposition targets in `docs/CONTEXT.md` and `PROJECT_PLAN_LIVE.md`, refreshed `## Context Highlights` and `## Immediate Next Actions`, and skipped validation because the work was documentation-only.
- Centralised queue helpers under `cli.queue_utils` (wrapping `clear_queue_action`, `generate_queue_summary`, `update_queue_data`), rewired `wgp` to delegate to the CLI implementation, and updated `QueueController.clear_queue` to share the helper; lifted status/reset functions (`clear_status`, `get_latest_status`, `update_status`) plus the refresh counter into `core.progress`, switched all callers (including the legacy notifier) to the new module, removed the duplicate `get_gen_info` from `wgp` in favour of the shared helper, refreshed plan/context docs with the new `core.task_inputs` extraction roadmap, and validated with `python -m compileall cli/queue_utils.py cli/queue_controller.py core/progress.py wgp.py`.

- Added `core/task_inputs.TaskInputManager` encapsulating task serialization (`prepare_inputs_dict`, `get_file_list`, `set_file_choice`, `save_inputs`) with explicit dependencies and a typed `SaveInputsPayload`, then wrapped `wgp.py` through `_get_task_inputs_manager()` so the legacy module delegates instead of scraping `locals()`.
- Extended `core/production_manager.ProductionManager` with `task_inputs()` and hydrated the manager inside `cli/queue_controller.QueueController` to share the new serializer; updated `docs/CONTEXT.md`/`PROJECT_PLAN_LIVE.md` with the follow-up tasks.
- Validation: `python -m py_compile core/task_inputs.py core/production_manager.py cli/queue_controller.py wgp.py`.
- Queue controller enqueue path now routes through `TaskInputManager.prepare_inputs_dict("metadata", ...)`, updating the LoRA URL cache, normalising activation lists, and storing queue metadata/attachment labels for summaries; queue entries keep prompt/repeat/asset flags without touching `wgp.update_loras_url_cache`, which was removed.
- Updated `PROJECT_PLAN_LIVE.md` and `docs/CONTEXT.md` to capture the new queue serialisation design and queued follow-up (porting preview thumbnail helpers into CLI space).
- Validation: `python -m py_compile cli/queue_controller.py wgp.py`.
- Moved settings hydration into `core.task_inputs.TaskInputManager.load_settings_from_file`, wiring `ProductionManager.task_inputs()` to supply the necessary dependencies so both `wgp` and the CLI stop importing the legacy helper; rewrote `cli.generate.load_settings_defaults` to use the shared manager, passed the cached instance into the runtime manager, and deleted the `wgp.get_settings_from_file` wrapper.
- Updated `PROJECT_PLAN_LIVE.md` and `docs/CONTEXT.md` to reflect the new loader location and removed the completed immediate action from the live plan.
- Validation: `python -m py_compile core/task_inputs.py core/production_manager.py cli/generate.py wgp.py`.
