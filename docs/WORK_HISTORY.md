# Work History

## Prior Summary
Wan2GP has been reshaped into a headless, CLI-first system that routes every generation job through deterministic queue orchestration. The Gradio-era globals were replaced by explicit runtime state: `cli.queue_controller.QueueController` owns sequencing and TCP control, while `cli.runner` and `cli.generate` surface structured logging, graceful aborts, and manifest emission. `ProductionManager.run_generation()` now acts as the single execution choke point, cloning metadata templates, preparing adapter payloads, and delegating to the remaining `wgp.generate_video` internals without mutating module-level state. Queue snapshots, prompt payload propagation, and notifier wiring are locked down by regression tests so automation can safely pause, resume, and introspect jobs in flight.

Persistence and metadata have followed the same consolidation. `core.io.media.MediaPersistenceContext` replaced the legacy `shared.utils.audio_video.save_*` shims, introducing retry-aware `save_video/save_image/save_audio/save_mask_archive` helpers that respect codec/container templates inferred from `server_config`. The CLI wraps each context with a manifest recorder, emitting JSONL rows (`manifests/run_history.jsonl`) once all artifacts land on disk and capturing adapter-payload hashes for reproducibility. Documentation in `docs/CLI.md`, `docs/APPENDIX_HEADLESS.md`, and `PROJECT_PLAN_LIVE.md` tracks the headless workflows, while `docs/CONTEXT.md` records architectural decisions, adapter lifecycles, and remaining extraction targets inside `wgp`.

MatAnyOne preprocessing has been brought to parity with generation flows. The pipeline now runs entirely headless, cloning `ProductionManager` metadata state, honouring mask archive toggles, and persisting videos via the shared context. CLI integration tests (`tests/test_matanyone_cli_integration.py`) assert manifest coverage for `mask_foreground`, `mask_alpha`, `rgba_archive`, and `audio` roles, while persistence tests (`tests/test_matanyone_persistence.py`) confirm codec overrides, mask gating, and context usage. Recent sessions retired bespoke `imageio` writers, stitched MatAnyOne into the manifest recorder, and set the stage for migrating remaining preprocessing utilities onto `core.io.media`.

The roadmap now focuses on peeling the final `wgp` globals, expanding adapter coverage, and sweeping lingering preprocessing helpers that still write media directly. Immediate priorities center on normalising persistence surfaces, enriching manifests with machine-readable metadata, and keeping the live documentation synchronized with each workflow change so future contributors can operate the CLI with minimal local context.

## 2025-11-05 (Session 8)
- Added `_persist_audio_artifacts` and `_load_audio_samples` inside `preprocessing/matanyone/app.py`, decoding extracted AAC tracks with `ffmpeg`, persisting canonical audio files via `MediaPersistenceContext.save_audio`, and recording per-track metadata (sample rate, channels, language, duration) in `MatAnyOneResult.metadata["audio_tracks"]`. JSON sidecars now emit for audio when `metadata_mode=json`.
- Extended `tests/test_matanyone_persistence.py` to stub `_load_audio_samples`, assert audio persistence through the recording context, validate metadata payloads/sidecar emission, and confirm cleanup still removes temporary mux inputs. Existing mask/archive assertions were updated to account for the new context calls.
- Updated documentation (`docs/CONTEXT.md`, `docs/APPENDIX_HEADLESS.md`, `docs/CLI.md`) and plan artifacts (`PROJECT_PLAN_LIVE.md`) to reflect the MatAnyOne audio persistence workflow. Rewrote `docs/WORK_HISTORY.md` summary to capture the CLI-first refactor trajectory and logged this sessionâ€™s work.
- Validation: `python -m unittest tests.test_matanyone_persistence`; `python -m unittest tests.test_matanyone_cli_integration`.
