# Work History

## Prior Sessions (summary up to 2025-11-01)
- Bootstrapped the headless CLI around `cli.generate`, migrated Gradio-only argument parsing into `cli.arguments`, and established reusable configuration assembly via `wgp.assemble_generation_params()`. Hardened runtime bootstrap with `wgp.ensure_runtime_initialized()` so non-interactive scripts share deterministic defaults without importing legacy UI code.
- Systematically removed Gradio widgets, galleries, and plugin infrastructure. Replaced UI callbacks with `shared.notifications` loggers, trimmed residual HTML helpers, and collapsed the web-only compatibility layer. Wan/Qwen/Chatterbox handlers now emit structured logs, and dormant wizard/preset flows were deleted in favour of explicit CLI flags.
- Re-architected queue orchestration: introduced `cli.queue_controller.QueueController`, AsyncStream-based progress forwarding, TCP control channel, and consolidated helpers under `cli.queue_utils` / `cli.queue_state`. Removed the legacy `wgp.process_tasks` loop and `--legacy-queue` flag, while adding pause/resume/abort semantics and smoke harness coverage.
- Reworked metadata and persistence: threaded `MetadataState` through `ProductionManager` and `GenerationRuntime`, replaced global metadata globals, and centralised IO in `core/io/media`. Added `MediaPersistenceContext`, JSON sidecar support, and consistent filename allocation to decouple persistence from `wgp`.
- Brought MatAnyOne into the headless ecosystem by building `cli.matanyone`, normalising metadata propagation via `ProductionManager.metadata_state()`, wiring mask/audio outputs through the shared writers, and documenting the contract across CLI docs and appendices.
- Introduced adapter shims for LoRA discovery (`core/lora/manager.LoRAInjectionManager`) and prompt enhancement (`core/prompt_enhancer/bridge.PromptEnhancerBridge`), updated CLI flows to hydrate via the adapters, and added unit coverage. Legacy `wgp.setup_loras` calls are now gated behind the adapters pending full extraction.
- Maintained living documentation: repeatedly pruned `PROJECT_PLAN_LIVE.md`, aligned roadmap milestones, and kept `docs/CLI.md`, `docs/APPENDIX_HEADLESS.md`, and `docs/CONTEXT.md` synced with each headless milestone. Work logs captured validation commands, metadata expectations, and pending design decisions.
- Expanded validation hygiene: standardised `python -m cli.generate --dry-run` smoke passes, added `cli.queue_controller_smoke` for queue regressions, and leaned on `python -m compileall` / targeted unittests to guard adapter refactors and IO rewrites.

## 2025-11-01
- Added deterministic adapter payload helpers to `core/task_inputs.TaskInputManager` (`build_lora_payload`, `resolve_prompt_enhancer`). Metadata preparation now embeds `adapter_payloads` so queue entries and downstream tooling capture server hashes, available weights/presets, activated selections, and enhancer mode/provider without revisiting `wgp` globals.
- Updated `cli.queue_controller.QueueController` to persist adapter payloads alongside task params and forward them to production runs. Queue entries now normalise LoRA selections, carry payloads for workers, and set `adapter_payloads` on stub metadata for smoke tests.
- Extended `core.production_manager.ProductionManager` and `GenerationRuntime` to request adapter payloads, update runtime state before invoking `wgp.generate_video`, and synchronise `state["loras"]` / `server_config["enhancer_enabled"]`. Runtime execution now relies on adapter caches, resets prompt enhancer bridges when disabled, and ensures `wgp` sees the injected `TaskInputManager`.
- Passed adapter payload plumbing through `cli/queue_controller_smoke` by supplying a stub task input manager, keeping the control-channel harness green after the queue changes.
- Refreshed project documentation: rewrote `PROJECT_PLAN_LIVE.md` immediate actions toward deleting the remaining `wgp` shims, updated `docs/CONTEXT.md`, `docs/CLI.md`, and `docs/APPENDIX_HEADLESS.md` with the new payload flow, and rebuilt `docs/WORK_HISTORY.md` per the handoff protocol.
- Validation: `python -m compileall core/task_inputs.py core/production_manager.py cli/queue_controller.py cli/queue_controller_smoke.py`; `python -m cli.generate --prompt "smoke test prompt" --dry-run --log-level INFO`; `python -m cli.queue_controller_smoke`. All commands completed successfully (queue smoke emitted `out.mp4` as expected).

## 2025-11-02
- Taught `wgp.generate_video` to consume queued LoRA adapter payloads directly: removed the `state["loras"]` dependency, honoured payload-provided `lora_dir`, and added optional overrides to `check_loras_exist`. The function now receives `adapter_payloads` explicitly and converts multipliers/activations from the payload before loading LoRAs.
- Added a prompt enhancer primer hook: `ProductionManager` now installs a bridge callback before `wgp.load_models` so `setup_prompt_enhancer` runs through `PromptEnhancerBridge` ahead of `offload.profile`. Direct calls from `load_models` were removed, new runtime handles (`prompt_enhancer_pipe/kwargs`) are published, and release paths reset the prompt enhancer globals.
- Updated `core/production_manager.GenerationRuntime` to forward adapter payloads into `wgp.generate_video`, removed the legacy state mutations, and ensured prompt enhancer priming/flags run through the bridge with safe fallbacks. `_ensure_model_ready` now sets server_config overrides from payloads, primes via the bridge when models reload, and resets caches when disabled.
- Introduced CLI cache reset toggles: `--reset-lora-cache` and `--reset-prompt-enhancer` surface adapter resets through `ProductionManager`, update runtime summaries, and emit informative logs. Documentation (`docs/CLI.md`, `docs/APPENDIX_HEADLESS.md`, `docs/CONTEXT.md`) was refreshed alongside `PROJECT_PLAN_LIVE.md` to capture the new workflow and next actions.
- Validation: `python -m compileall core/production_manager.py cli/generate.py cli/arguments.py wgp.py`; `python -m cli.generate --prompt "smoke test prompt" --model-type t2v --dry-run --log-level INFO --reset-lora-cache --reset-prompt-enhancer`; `python -m cli.queue_controller_smoke`. All commands succeeded.
