# Work History

## Prior Summary
Wan2GPâ€™s headless refactor has converged on a ProductionManager-centric architecture that feeds both generation and preprocessing flows through explicit metadata and persistence contexts. Queue orchestration now lives entirely in `cli.queue_controller`, replacing the legacy Gradio loop while preserving pause/resume and telemetry hooks. The CLI frontends delegate persistence to `MediaPersistenceContext`, and manifest recording captures every saved artifact so downstream automation can reason about reproducibility inputs, codec/container choices, and adapter payload hashes. Prompt enhancer and LoRA handling moved behind dedicated adapters (`PromptEnhancerBridge`, `LoRAInjectionManager`) that expose cached discovery, payload snapshots, and reset hooks; queue payloads snapshot the adapter state to keep workers deterministic. MatAnyOne adopted the same context pipeline, added manifest emission with per-run codec overrides, and documents the workflow alongside `cli.generate` inside the headless CLI guide. Regression coverage now spans queue prompt payload propagation, LoRA/prompt enhancer adapter behaviour, MatAnyOne persistence semantics, and manifest assembly, closing the loop on the core smoke suites that guard the CLI transition.

## 2025-11-03 (Session 6)
- Removed the transitional `shared.utils.audio_video.save_*` adapters, cleaned up the stray import in `models/wan/any2video.py`, and left the module focused on audio track helpers plus metadata readers so all persistence now routes through `core.io.media`.
- Added `tests/test_matanyone_cli_integration.py`, which patches the heavy pipeline while invoking `cli.matanyone` end-to-end to assert manifest entries capture `mask_foreground`, `mask_alpha`, and `rgba_archive` artifacts alongside JSON sidecars when running in `--metadata-mode json`.
- Updated architectural notes (`docs/CONTEXT.md`, `docs/IO_MEDIA_MIGRATION.md`, `docs/APPENDIX_HEADLESS.md`, `docs/CLI.md`) to reflect the removal of the legacy shims and the new integration coverage.
- Validation: `python -m unittest tests.test_matanyone_cli_integration tests.test_matanyone_manifest`
