# Work History

## Prior Summary
The Wan2GP refactor has progressively shifted execution away from legacy Gradio-era globals into a deterministic, CLI-first architecture orchestrated by `ProductionManager`. Queue lifecycle management now lives entirely under `cli.queue_controller`, exposing pause/resume/status operations over a TCP control surface while tests such as `tests/test_queue_prompt_payloads.py` ensure enhanced prompt payloads travel intact through queued jobs. Generation entry points (`cli.generate`, `cli.matanyone`) bootstrap runtime state with `wgp.ensure_runtime_initialized()`, assemble reproducible request payloads, and delegate execution to `ProductionManager.run_generation()` which threads adapter payloads, metadata clones, and persistence contexts into the remaining `wgp.generate_video` backend. LoRA and prompt enhancer handling have been decoupled through `core.lora.manager.LoRAInjectionManager` and `core.prompt_enhancer.bridge.PromptEnhancerBridge`, providing cached discovery, reset hooks, and queue-friendly payload snapshots that prevent workers from mutating global state.

Media persistence was consolidated into `core.io.media.MediaPersistenceContext`, exposing retry-aware `save_video/save_image/save_audio/save_mask_archive` helpers that share codec/container defaults and manifest recording across generation and preprocessing flows. The CLI wraps each persistence context with `cli.manifest.ManifestRecorder`, emitting JSONL manifests (`manifests/run_history.jsonl`) that capture artifact roles, codecs, metadata sidecars, and adapter payload hashes only after successful writes; dry runs intentionally skip emission. MatAnyOne adopted the same persistence pipeline, inheriting codec overrides, metadata cloning, and mask archive gating via the `save_masks` toggle. Documentation in `docs/CLI.md` and `docs/APPENDIX_HEADLESS.md` tracks the evolving CLI surface, while `docs/CONTEXT.md` and `docs/IO_MEDIA_MIGRATION.md` log architectural decisions and the staged retirement of legacy helpers. Automated coverage now spans core queue behaviour, adapter shims, MatAnyOne persistence semantics, and manifest assembly, providing smoke-level guarantees around the headless workflows.

Historical cleanup removed `shared.utils.audio_video.save_*`, migrated MatAnyOne fallbacks onto `core.io.media.write_video`, and extended integration coverage so CLI runs emit manifest entries for `mask_foreground`, `mask_alpha`, and `rgba_archive` artifacts alongside JSON sidecars when `--metadata-mode json` is selected. Prior sessions also aligned metadata handling by cloning per-run templates (`MetadataState`) and routing embedded/JSON decisions through CLI flags, ensuring preprocessing and generation maintain parity. The outstanding roadmap continues to target remaining global dependencies inside `wgp`, adapter orchestration improvements, and broader persistence unification across preprocessing utilities that still invoke bespoke `imageio` writers.

## 2025-11-04 (Session 7)
- Removed the dormant `shared.utils.utils.save_image` helper and refactored `models/wan/fantasytalking/utils.py` plus `models/wan/multitalk/multitalk_utils.py` to rely on `core.io.media.write_video` (via `VideoSaveConfig`) so preprocessing helpers share the retry/logging surface used by the CLI.
- Extended `cli/manifest.build_matanyone_artifacts` to translate recorded `audio` captures into manifest entries, normalising container/codec metadata and wiring JSON sidecar paths for audio artifacts.
- Augmented `tests/test_matanyone_cli_integration.py` with a stubbed `MediaPersistenceContext` to simulate audio saves, asserting manifests now report `audio` roles alongside the existing mask entries; preserved the original mask coverage test.
- Updated documentation (`docs/CONTEXT.md`, `docs/APPENDIX_HEADLESS.md`, `docs/CLI.md`) to reflect the retired persistence helpers and the expanded MatAnyOne manifest surface.
- Revised `PROJECT_PLAN_LIVE.md` immediate next actions to focus on real audio persistence within MatAnyOne and a broader sweep of remaining `imageio` writers.
- Validation: `python -m unittest tests.test_matanyone_cli_integration`.
