# Work History

## Prior Summary
Wan2GP has been reshaped from a Gradio-bound prototype into a deterministic CLI-oriented toolkit. Early passes rewired argument parsing under `cli.arguments`, collapsed queue orchestration into `cli.queue_controller` with AsyncStream-backed state management, and replaced UI callbacks with structured logging plus the lightweight TCP control surface. The CLI entry points (`cli.generate`, `cli.matanyone`, `cli.queue_control`) now boot through `wgp.ensure_runtime_initialized()`, guaranteeing consistent configuration loading and notifier wiring for both operators and automation. Alongside the runtime cleanup, the last UI remnants—gallery widgets, theme toggles, and plugin scaffolding—were pruned so that queue telemetry, status updates, and abort handling now flow entirely through the headless notifier bridge.

Adapter extraction followed, peeling LoRA discovery and prompt enhancement into `core.lora.manager.LoRAInjectionManager` and `core.prompt_enhancer.bridge.PromptEnhancerBridge`. `ProductionManager` now venders these adapters, letting queue payloads capture deterministic snapshots while eliminating the legacy global mutations in `wgp.generate_video`. Smoke tests and unit suites (`tests/test_lora_manager.py`, `tests/test_prompt_enhancer_bridge.py`, `tests/test_queue_prompt_payloads.py`) guard the new plumbing, and CLI reset flags expose cache invalidation without poking module-level state. The queue metadata path preserves enhancer and LoRA payloads so background workers replay identical contexts when dequeuing work.

Persistence has been consolidated around `core.io.media.MediaPersistenceContext`. The context templates clone codec/container/audio/mask settings from `server_config`, and helper methods (`save_video`, `save_image`, `save_audio`, `save_mask_archive`) provide retry-aware persistence while respecting the `save_masks` toggle. Recent sessions routed `wgp.generate_video` through these helpers, extended the context with audio and mask configs, and added coverage in `tests/test_media_context.py` to ensure mask archives obey the toggle and audio saves fall back gracefully when dependencies are missing. Documentation (`docs/CLI.md`, `docs/APPENDIX_HEADLESS.md`, `docs/CONTEXT.md`) and the live project plan have been kept in sync with each milestone so future agents inherit an accurate mental model, while the roadmap continues to track runner extraction, artifact manifest emission, and the eventual retirement of the legacy save wrappers.

## 2025-11-01
- Threaded `ProductionManager.media_context()` through `cli/matanyone` alongside the existing metadata snapshot, keeping fallback logging consistent when `wgp` initialisation fails but ensuring CLI runs pick up runtime codec/container overrides when it succeeds.
- Refactored `preprocessing/matanyone/app.py` to persist foreground/alpha videos through `MediaPersistenceContext.save_video`, derive container-aware paths, and gate RGBA ZIP emission behind the context `save_masks` toggle while retaining legacy fallbacks when no context is available.
- Updated metadata payloads to report the effective codec/container, ensured audio reattachment reuses the context-defined container, and mirrored the new persistence flow across CLI output messaging.
- Refreshed `docs/CLI.md`, `docs/APPENDIX_HEADLESS.md`, and `docs/CONTEXT.md` to document the context-driven MatAnyOne behaviour; pruned `PROJECT_PLAN_LIVE.md` to note completion of the MatAnyOne persistence port and added a follow-up task for automated coverage.
- Validation: `python -m unittest tests.test_media_context` and `python -m compileall cli/matanyone.py preprocessing/matanyone/app.py`.
