# Work History

## Summary Through 2025-11-03
Wan2GP has completed the transition from a Gradio-bound prototype to a reproducible, scriptable CLI. Argument parsing and validation now live under `cli.arguments`, the queue controller was rewritten around `AsyncStream`, and `cli.generate`/`cli.matanyone` expose deterministic entry points backed by structured logging. Early sessions deleted the remaining UI widgets, galleries, and plugin scaffolding, replacing them with progress callbacks, notifier bridges, and a thin TCP control surface for pause/resume/status. The runtime bootstrap moved into `wgp.initialize_runtime()` so both the CLI and automation scripts reuse one path for loading `wgp_config.json`, normalising directories, and seeding defaults.

The adapter stack was peeled out of `wgp`: `core.lora.manager.LoRAInjectionManager` and `core.prompt_enhancer.bridge.PromptEnhancerBridge` cache discovery and priming per server snapshot, while `ProductionManager` threads those payloads through task preparation, queue metadata, and execution. Queue entries now ship deterministic adapter payloads, and CLI flags (`--reset-lora-cache`, `--reset-prompt-enhancer`) expose cache resets without poking globals. Smoke harnesses cover queue control flows, and unit tests assert that CLI reset helpers call through to the adapters. Documentation across `docs/CLI.md`, `docs/APPENDIX_HEADLESS.md`, and `docs/CONTEXT.md` tracks these changes so operators understand how to activate enhancers, inspect LoRA inventories, and monitor queue state without the UI.

By 2025-11-03 the persistence layer had been consolidated: `MediaPersistenceContext.save_video/save_image` replaced legacy save helpers, `GenerationRuntime` computed enhanced prompts up front, and `wgp.generate_video` consumed the adapter payloads without touching global enhancer state. New helpers centralised cache resets, the plan/live docs captured the roadmap, and regression checks (`python -m cli.generate ... --dry-run`, `python -m cli.queue_controller_smoke`, and targeted unittests) kept the headless flow stable while UI-era shims were removed.

## 2025-11-04
- Expanded `core/io/media.MediaPersistenceContext` with `AudioSaveConfig`/`MaskSaveConfig`, plus `save_audio` and `save_mask_archive` helpers that handle retries, logger injection, and the `save_masks` toggle. `build_media_context` now seeds audio/mask templates from `server_config`.
- Refactored `wgp.generate_video` to route audio writes through `_save_audio_artifact` (wrapping `soundfile`) and mask ZIP creation through `_save_mask_archive`, eliminating direct `sf.write`/`write_zip_file` calls while preserving filename semantics.
- Added `tests/test_media_context.py` to cover audio/mask persistence options and `tests/test_queue_prompt_payloads.py` to ensure queue entries, tracker snapshots, and metadata retain enhanced prompt payloads.
- Updated `docs/CLI.md`, `docs/APPENDIX_HEADLESS.md`, and `docs/CONTEXT.md` to document the expanded media context, queue metadata guarantees, and future manifest work; refreshed `PROJECT_PLAN_LIVE.md` with new immediate next actions (MatAnyOne context adoption, artifact manifest spec, and deprecating the legacy save wrappers).
- Validated via `python -m unittest tests.test_media_context tests.test_queue_prompt_payloads tests.test_cli_reset_flags`, `python -m cli.generate --prompt "smoke test prompt" --model-type t2v --dry-run --log-level INFO`, and `python -m cli.queue_controller_smoke`.
