# Work History

## Prior Summary
Wan2GP has been reshaped from a Gradio-bound experiment into a lean CLI system through a multi-session effort that prioritised determinism and reproducibility. The earliest passes eliminated gallery widgets, theme toggles, and plugin scaffolding, replacing them with structured logging and notifier feeds that surface progress exclusively through the terminal. Argument parsing moved under `cli.arguments`, while the queue stack consolidated around `cli.queue_controller`, `cli.queue_state`, and `cli.queue_utils`, giving the headless runner a single source of truth for pending tasks, pause/resume toggles, and abort semantics. A lightweight TCP control surface exposed by `cli.queue_control_server` kept remote automation viable without reintroducing GUI dependencies, and every CLI entry point (`cli.generate`, `cli.matanyone`, `cli.queue_control`) now boots through `wgp.ensure_runtime_initialized()` so configuration loading, notifier registration, and runtime checks remain uniform whether a human or scheduler invokes the tool.

As orchestration matured, the CLI runner gained higher-fidelity hooks into runtime state. `cli.runner` centralises notifier construction, queue telemetry, and `KeyboardInterrupt` cleanup, ensuring `state["gen"]` and the ProductionManager stay aligned. Task ingestion flows through `TaskInputManager` and the queue payload snapshot logic captured in `tests/test_queue_prompt_payloads.py`, so each dequeued job reconstructs the exact metadata, adapter payloads, and server overrides recorded at submission time. These changes retired the last UI-centric assumptions about global state, making it safe for background processes to handle generation without ever touching legacy Gradio callbacks or front-end specific environment variables.

Core model orchestration pivoted around adapters. `core.lora.manager.LoRAInjectionManager` and `core.prompt_enhancer.bridge.PromptEnhancerBridge` wrap the heavy discovery and priming logic for LoRAs and prompt enhancers, exposing memoised inventories, preset resolution, cache resets, and snapshot export. `ProductionManager` vends these adapters so queue controllers and CLI runs reuse hydrated state instead of re-scanning the filesystem or mutating globals inside `wgp`. Tests such as `tests/test_lora_manager.py` and `tests/test_prompt_enhancer_bridge.py` validate that caches hydrate deterministically, presets resolve consistently, and reset hooks clear state without side effects, paving the way for the planned runner extraction that will lift the remaining orchestration glue out of the legacy module.

Persistence surfaced as another pillar of the headless architecture. `core.io.media.MediaPersistenceContext` now carries cloned templates for video, image, audio, and mask outputs, providing retry-aware `save_*` helpers that respect codec/container overrides and the historical `save_masks` debug switch. Generation and preprocessing pipelines delegate to this context, which keeps logging consistent, prevents filename drift, and removes the need for ad-hoc save wrappers. MatAnyOne preprocessing followed suit: `cli/matanyone.py` clones both the metadata snapshot and media context from `ProductionManager` so `preprocessing/matanyone/app.py` writes foreground, alpha, and optional RGBA archives using the same templates as the main generator. Metadata emission honours CLI flags for JSON versus embedded bundles, and recent sessions recorded validation expectations in the live plan to codify dry-run smoke tests, MatAnyOne checks, and timing/VRAM logging for heavier runs. Documentation—`docs/CLI.md`, `docs/APPENDIX_HEADLESS.md`, `docs/CONTEXT.md`, and `PROJECT_PLAN_LIVE.md`—has been continuously updated to capture these architectural shifts, ensuring future contributors inherit a current mental model while the roadmap tracks remaining milestones such as artifact manifest emission, queue-runner extraction, and the retirement of legacy persistence wrappers.

## 2025-11-01 (Session 2)
- Added `tests/test_matanyone_persistence.py` with a `RecordingContext` test double that verifies MatAnyOne video saves honor `MediaPersistenceContext` overrides and that mask archives respect the `save_masks` gating semantics.
- Updated `PROJECT_PLAN_LIVE.md` to note completion of the MatAnyOne persistence coverage, add a follow-up task for audio mux testing, and keep `## Immediate Next Actions` focused.
- Extended `docs/CONTEXT.md` to record the new persistence coverage guarantees and rebuilt `docs/WORK_HISTORY.md` per the handoff protocol.
- Validation: `python -m unittest tests.test_matanyone_persistence` (pass).
