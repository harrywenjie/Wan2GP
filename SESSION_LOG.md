# Session Log

## Prior Summary
Wan2GP has been reoriented into a headless, CLI-first workflow where every generation path travels through `core.production_manager.ProductionManager.run_generation()`. The CLI entrypoints clone metadata templates, prepare adapter payloads, and dispatch work without reviving the retired Gradio shell. Queue orchestration now lives entirely under `cli/`, with `QueueController` handling enqueue, pause/resume orchestration, and abort signalling while `QueueControlServer` exposes a TCP control plane that mirrors the legacy UX capabilities. State tracking stays in `cli.queue_state.QueueStateTracker`, which rebuilds textual summaries and queue metrics from scratch, avoiding `wgp` globals and unlocking deterministic telemetry across runs.

The extraction to `MediaPersistenceContext` consolidated video, image, audio, and mask persistence under `core.io.media`, replacing a patchwork of helpers in `shared.utils.audio_video`. `ProductionManager.media_context()` and `metadata_state()` now stage per-run clones so downstream pipelines receive immutable templates; JSON manifests are emitted through `ManifestRecorder`, and embedded metadata mirrors CLI flags such as `--metadata-mode`. Refactors also removed legacy persistence shims, while new retry-aware writers guarantee consistent logging and error handling across codec overrides.

MatAnyOne preprocessing mirrors these headless patterns. `preprocessing/matanyone/app.py` decodes source audio with `ffmpeg`, persists artifacts through the shared media context, records per-track metadata, and pushes results into manifests and CLI logs. The CLI wrapper in `cli/matanyone.py` forwards notifier wiring, honours metadata/persistence contexts, and routes outputs into `mask_outputs/` with optional RGBA archives that depend on the `save_masks` toggle. Regression coverage spans persistence (`tests/test_matanyone_persistence.py`), CLI integration (`tests/test_matanyone_cli_integration.py`), and manifest schemas, keeping queue telemetry and sidecars aligned with production expectations.

Queue telemetry was broadened so MatAnyOne audio metadata (`path`, `sample_rate`, `duration_s`, `language`, `channels`) flows from the pipeline into queue summaries and the TCP status payload. `tests/test_queue_audio_metadata.py` verifies normalisation and propagation, while `tests/test_queue_prompt_payloads.py` guards enriched prompt payloads for downstream automation. CLI notifications run through `cli.runner`, which supplies the deterministic notifier, progress callback builder, and `send_cmd` wiring reused by generation and preprocessing entrypoints. Pause/resume semantics respect `gen_lock`, ensuring consistent coordination between control commands and worker threads.

Documentation keeps pace with the refactor: `PROJECT_PLAN_LIVE.md`, `docs/CLI.md`, and `docs/APPENDIX_HEADLESS.md` capture the headless workflows, queue orchestration, and artifact manifests. Installation and troubleshooting guides were rewritten for the CLI-only environment, and LoRA/model catalogues describe configuration-driven runs. Active roadmap items focus on peeling residual GUI dependencies, finalising disk-first mask and voice pipelines, and emitting machine-readable manifest hashes for downstream automation. Deferred work tracks a production-manager-centric repository reorganisation once the current milestones land.

## 2025-11-02 (Session 13)
- Extended the smoke harness in `cli/queue_controller_smoke.py` by letting `_StubManager` accept seeded audio metadata and restore `state["gen"]["audio_tracks"]` under `gen_lock`, matching how MatAnyOne publishes telemetry during real runs.
- Updated `run_smoke()` to inject a representative audio track, verify the TCP `status` payload echoes the normalised metadata, and assert the textual queue summary prints path, sample rate, duration, language, and channel details for downstream operators.
- Refreshed `PROJECT_PLAN_LIVE.md` (milestone completion note, new multi-track follow-up, updated `## Immediate Next Actions`) and `LIVE_CONTEXT.md` to document the new guardrails; ensured the working plan reflects the remaining migration tasks.
- Validation: `python -m cli.queue_controller_smoke` (passes; prints deterministic output list, confirming the harness now guards audio telemetry end-to-end).
