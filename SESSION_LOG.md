# Session Log

## Prior Summary
Wan2GP has been refactored into a headless, CLI-first toolkit where every generation request runs through explicit queue orchestration and manifest logging. The queue controller (`cli.queue_controller`) now owns scheduling, pause/resume handling, and the TCP control channel, while `cli.runner`/`cli.generate` keep notifier wiring, structured logging, and deterministic abort behaviour in lock-step with `ProductionManager.run_generation()`. That runtime wrapper clones metadata templates, prepares adapter payloads (prompt enhancer and LoRA), and delegates into the remaining `wgp.generate_video` internals without mutating the legacy globals that complicated reproducibility.

Persistence flows were consolidated on `core.io.media.MediaPersistenceContext`, replacing scattered `shared.utils.audio_video.save_*` shims. Video, image, audio, and mask saves now share retry-aware writers, respect container/codec templates from `server_config`, and funnel through a `ManifestRecorder` so each CLI run emits a JSONL line with artifacts, metadata mode, and adapter hashes. Documentation across `docs/CLI.md`, `docs/APPENDIX_HEADLESS.md`, and `PROJECT_PLAN_LIVE.md` stays aligned with these workflows, while `LIVE_CONTEXT.md` tracks architectural decisions plus the shrinking list of `wgp` dependencies that still need extraction.

MatAnyOne preprocessing mirrors the same persistence pipeline. The CLI clones `ProductionManager.metadata_state()`, honours the shared `MediaPersistenceContext`, reattaches source audio when requested, and persists mask archives conditionally via the `save_masks` toggle. Regression suites (`tests/test_matanyone_persistence.py`, `tests/test_matanyone_cli_integration.py`, `tests/test_matanyone_manifest.py`) assert codec/container overrides, manifest emission, JSON sidecars, and the enriched audio metadata (sample rate, duration, language, channels, source codec) that now appears in logs and manifests for downstream mux workflows.

## 2025-11-02 (Session 11)
- Extended queue telemetry so MatAnyOne audio metadata is captured alongside queue summaries and status payloads. `preprocessing/matanyone/app.py` now records normalised audio entries (`path`, `sample_rate`, `duration_s`, `language`, `channels`) into `state["gen"]["audio_tracks"]`, while `cli.queue_state` and `cli.queue_controller` propagate the data through queue metrics, textual summaries, and the TCP `status` response.
- Updated docs and live context to describe the new `audio_tracks` surface area (`docs/CLI.md`, `docs/APPENDIX_HEADLESS.md`, `LIVE_CONTEXT.md`) and refreshed the project plan with a follow-up smoke-test task in `## Immediate Next Actions` plus a roadmap completion note under Milestone 3.
- Added regression coverage in `tests/test_queue_audio_metadata.py` to exercise audio-track normalisation, queue summaries, and metrics propagation; existing queue payload tests remain intact. Verification: `python -m unittest tests.test_queue_audio_metadata tests.test_queue_prompt_payloads tests.test_matanyone_cli_integration`.
