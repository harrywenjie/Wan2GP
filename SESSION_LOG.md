# Session Log

## Prior Summary
Wan2GP has been reshaped into a headless, CLI-first system where every generation request flows through explicit queue orchestration and manifest logging. `cli.queue_controller` now owns scheduling, pause/resume, and control-port handling, while `cli.runner` and `cli.generate` provide structured logging, deterministic aborts, and a JSONL manifest that captures run inputs plus adapter hashes. `ProductionManager.run_generation()` sits at the execution choke point: it clones metadata templates, prepares adapter payloads (prompt enhancer, LoRA), and delegates to the remaining `wgp.generate_video` internals without mutating legacy globals. Adapter shims, queue snapshot propagation, and notifier wiring are all protected by targeted unit tests so automation can rely on the CLI without inheriting Gradio-era state.

Persistence has been consolidated onto `core.io.media.MediaPersistenceContext`, replacing the ad-hoc `shared.utils.audio_video.save_*` helpers. Video, image, audio, and mask saves now share retry-aware writers, respect codec/container templates from `server_config`, and emit structured metadata bundles. `ManifestRecorder` wraps each context to capture persistence events, producing reproducible JSONL records that enumerate artifacts (`mask_foreground`, `mask_alpha`, `rgba_archive`, `audio`) alongside metadata mode and adapter hashes. Documentation in `docs/CLI.md`, `docs/APPENDIX_HEADLESS.md`, and `PROJECT_PLAN_LIVE.md` stays live with these workflows, while `LIVE_CONTEXT.md` tracks architectural decisions, adapter lifecycles, and the remaining extraction targets inside `wgp`.

MatAnyOne preprocessing now mirrors the generation pipeline. The headless CLI clones `ProductionManager` metadata state, honours mask archive toggles, persists artifacts through the shared context, and reattaches source audio when requested. Tests (`tests/test_matanyone_persistence.py`, `tests/test_matanyone_cli_integration.py`, `tests/test_matanyone_manifest.py`) verify codec/container overrides, manifest emission, JSON sidecars, and schema expectations so downstream automation can trust the emitted artifacts. Recent iterations extended `_persist_audio_artifacts` to derive canonical audio metadata (sample rate, duration, language, channels, source codec) for every saved track, logging the details through `cli.matanyone` and embedding them in manifests to keep mux workflows deterministic.

## 2025-11-02 (Session 9)
- Threaded MatAnyOne audio metadata into CLI logging and manifest assembly: `_persist_audio_artifacts` now normalises sample rates, computes durations from decoded buffers, and stores per-track metadata (including channels, language, and source codec) before writing JSON sidecars. `cli.matanyone` reuses a normalised metadata helper to log each audio artifact and passes the structured list into `build_matanyone_artifacts`, which enriches manifest rows with `sample_rate`, `duration_s`, `language`, and `channels`.
- Updated test coverage to lock in the new behaviour: `tests/test_matanyone_persistence.py` verifies audio sidecars capture duration and language, `tests/test_matanyone_manifest.py` asserts manifest audio entries expose the expanded metadata, and `tests/test_matanyone_cli_integration.py` now checks both manifest fields and INFO-level audio logs. Ran `python -m unittest tests.test_matanyone_persistence`, `python -m unittest tests.test_matanyone_cli_integration`, and `python -m unittest tests.test_matanyone_manifest`.
- Documented the updated manifest schema and CLI behaviour (`docs/CLI.md`, `docs/APPENDIX_HEADLESS.md`, `LIVE_CONTEXT.md`), refreshed `PROJECT_PLAN_LIVE.md` (added the completion note, adjusted validation guidance, and replaced the finished immediate next action with a queue-metadata follow-up), and rewrote this work history with the latest summary plus todayâ€™s entry.

## 2025-11-02 (Session 10)
- Added short descriptions to the `## Project Specific Docs` section in `PROJECT_PLAN_LIVE.md` so maintainers can see at a glance what each document covers.
- No code or validation changes required for this housekeeping pass.
